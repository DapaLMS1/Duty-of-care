<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duty of Care: Legal Obligations - Flashcards</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind Configuration with custom colors (Deep Violet and Lavender Palette) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-violet': '#532A8C',       /* Primary Dark Color */
                        'muted-lavender': '#9D8ABB',    /* Secondary Accent Color */
                        'content-bg': '#F2F2F2',        /* Very light background for content area */
                        'check-green': '#7ABF49',       /* Vibrant Green for checkmarks */
                    }
                }
            }
        }; 
    </script>

    <style>
        /* Apply the Inter font globally */
        body {
            font-family: 'Inter', sans-serif;
            background-color: white; 
        }

        /* --- FLIP CARD STYLES --- */
        .flip-card {
            background-color: transparent;
            perspective: 1000px;
            cursor: pointer;
            height: 230px; /* Adjusted height for content fit */
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s; /* Smooth flip animation */
            transform-style: preserve-3d; /* Required for the 3D effect */
        }

        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Hide the back of the element when facing away */
            backface-visibility: hidden;
            border-radius: 0.75rem; /* rounded-xl equivalent */
            display: flex;
            flex-direction: column; /* Allow content to stack */
            align-items: flex-start; /* Align content to the left */
            justify-content: space-between; /* Push button to the bottom */
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl equivalent */
            border: 1px solid #e5e7eb; /* Subtle border for definition */
            text-align: left;
        }
        
        /* Front side styling (Purple / White Text) */
        .flip-card-front {
            background-color: #532A8C; /* deep-violet */ 
            color: white;
            z-index: 2;
            text-align: center; 
            align-items: center; /* Center content vertically on front */
            justify-content: center; /* Center content horizontally on front */
        }

        /* Back side styling (White / Purple Text) - INVERTED */
        .flip-card-back {
            background-color: white;
            color: #532A8C; /* deep-violet */
            transform: rotateY(180deg);
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #532A8C;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="w-full max-w-6xl overflow-hidden">
        
        <!-- FLIP CARD GRID -->
        <div id="card-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">

            <!-- Card 1: Establishment -->
            <div class="flip-card" onclick="this.classList.toggle('flipped')">
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <h2 class="text-3xl font-extrabold">Establishment</h2>
                    </div>
                    <div class="flip-card-back">
                        <p class="text-base font-semibold mb-3">
                            A duty of care is automatically established once a <strong>patient-healthcare provider relationship begins</strong> (e.g., when a patient attends the practice). This immediate link is the foundation of legal accountability.
                        </p>
                        <button 
                            class="mt-auto w-full text-white bg-deep-violet hover:bg-muted-lavender transition-colors py-2 px-4 rounded font-bold shadow-md text-sm"
                            onclick="event.stopPropagation(); generateScenario('Establishment')"
                        >
                            Generate Scenario ✨
                        </button>
                    </div>
                </div>
            </div>

            <!-- Card 2: Standard of Care (Australian Context) -->
            <div class="flip-card" onclick="this.classList.toggle('flipped')">
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <h2 class="text-3xl font-extrabold">Standard of Care</h2>
                    </div>
                    <div class="flip-card-back">
                        <!-- UPDATED TEXT APPLIED HERE -->
                        <p class="text-base font-semibold mb-3">
                            The standard is the <strong>National Minimum Standard</strong> set by AHPRA and the Dental Board. It requires a <strong>reasonably competent dental professional</strong> (e.g., Dental Assistant) to operate strictly within the <strong>Code of Conduct and established protocols</strong>.
                        </p>
                        <button 
                            class="mt-auto w-full text-white bg-deep-violet hover:bg-muted-lavender transition-colors py-2 px-4 rounded font-bold shadow-md text-sm"
                            onclick="event.stopPropagation(); generateScenario('Standard of Care')"
                        >
                            Generate Scenario ✨
                        </button>
                    </div>
                </div>
            </div>

            <!-- Card 3: Breach of Code of Conduct (Australian Context) -->
            <div class="flip-card" onclick="this.classList.toggle('flipped')">
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <h2 class="text-3xl font-extrabold">Breach of Code of Conduct</h2>
                    </div>
                    <div class="flip-card-back">
                        <p class="text-base font-semibold mb-3">
                            A breach of the Code of Conduct occurs when a dental professional's actions violate the <strong>professional standards or ethical guidelines</strong> established by AHPRA, the Dental Board, or DAPA.
                        </p>
                        <button 
                            class="mt-auto w-full text-white bg-deep-violet hover:bg-muted-lavender transition-colors py-2 px-4 rounded font-bold shadow-md text-sm"
                            onclick="event.stopPropagation(); generateScenario('Breach of Code of Conduct')"
                        >
                            Generate Scenario ✨
                        </button>
                    </div>
                </div>
            </div>

            <!-- Card 4: Negligence (Australian Context) -->
            <div class="flip-card" onclick="this.classList.toggle('flipped')">
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <h2 class="text-3xl font-extrabold">Negligence</h2>
                    </div>
                    <div class="flip-card-back">
                        <p class="text-base font-semibold mb-3">
                            Negligence is a <strong>breach of the duty of care that legally results in harm</strong>. Dental professionals can be held personally responsible for negligence, emphasizing strict adherence to AHPRA guidelines and practice protocols.
                        </p>
                        <button 
                            class="mt-auto w-full text-white bg-deep-violet hover:bg-muted-lavender transition-colors py-2 px-4 rounded font-bold shadow-md text-sm"
                            onclick="event.stopPropagation(); generateScenario('Negligence')"
                        >
                            Generate Scenario ✨
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- LLM Output Area -->
        <div class="mt-12 p-6 bg-content-bg rounded-xl shadow-xl border border-gray-200">
            <!-- UPDATED HEADING -->
            <h3 class="text-xl font-bold text-deep-violet mb-3" id="scenario-topic">Dental Practice Scenario Generator</h3>
            
            <div id="scenario-loading" class="hidden flex items-center space-x-3 text-deep-violet font-semibold">
                <div class="loading-spinner"></div>
                <span>Generating scenario...</span>
            </div>

            <div id="llm-output" class="min-h-[50px]">
                <!-- UPDATED PLACEHOLDER TEXT -->
                <p class="text-gray-500 italic">Click a 'Generate Scenario ✨' button on the back of any flashcard to see a real-world example grounded in dental practice!</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Global variables for Firebase setup (required by environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        // API Key setup - Empty string lets the environment inject the key securely at runtime
        const apiKey = ""; 
        
        let db, auth; 
        let userId = null;

        // Utility functions and Firebase imports (required by environment)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        async function setupFirebaseAndAuth() {
            try {
                // setLogLevel('Debug'); // Enable for detailed Firestore logging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
            } catch (error) {
                console.error("Firebase/Auth setup failed:", error);
            }
        }

        window.onload = setupFirebaseAndAuth; 

        // LLM Generation Logic
        window.generateScenario = async function(topic) {
            const outputContainer = document.getElementById('llm-output');
            const topicDisplay = document.getElementById('scenario-topic');
            const loadingDiv = document.getElementById('scenario-loading');

            outputContainer.innerHTML = '';
            // When a specific topic is selected, update the title to reflect that
            topicDisplay.textContent = `Scenario for: ${topic}`; 
            loadingDiv.classList.remove('hidden');

            // The user query is dynamically generated based on the card title clicked.
            let userQuery = `Generate a concise, realistic, and educational case study/scenario (3 sentences max) that illustrates the specific legal concept of: ${topic} in a dental practice context.`;
            
            // --- QUERY CUSTOMIZATION LOGIC ---
            if (topic === 'Establishment') {
                 // NEW constraint focusing on waste management protocols vs. household waste
                 userQuery += ` The scenario must illustrate the immediate establishment of duty of care by requiring the Dental Assistant to correctly handle and dispose of clinical waste (e.g., sharps, contaminated dressings) according to strict healthcare protocols, contrasting this with how they would handle common household trash.`;
            } else if (topic === 'Breach of Code of Conduct') {
                 // Constraint to focus on ethics/standards, not privacy/confidentiality
                 userQuery += ` The scenario must focus on a breach of ethical guidelines or professional standards (e.g., scope of practice, professional relationships), and explicitly must not involve a breach of patient privacy or confidentiality.`;
            } else if (topic === 'Standard of Care') {
                 // Constraint to focus on a 'soft skill' failure
                 userQuery += ` The scenario must illustrate a failure in a 'soft skill' (e.g., poor communication, inadequate documentation, or patient management) by the Dental Assistant that leads to a lapse in the expected standard of care, but not resulting in physical harm (yet).`;
            } else if (topic === 'Negligence') {
                 // Constraint to focus on the Dental Assistant as the sole negligent party
                 userQuery += ` The scenario must illustrate a direct action or clear omission by the Dental Assistant alone that constitutes a breach of the duty of care and results in demonstrable patient harm (the four elements of negligence must be met by the DA's action). The dentist's role must be secondary or absent from the negligent act itself.`;
            }
            // ---------------------------------

            // The system prompt keeps the Australian context strict.
            const systemPrompt = "You are an expert legal educator for healthcare professionals. The scenario should be grounded specifically in the dental assisting or a related healthcare field. The tone must be professional and direct and reference Australian law/regulatory bodies like AHPRA or state law where relevant.";
            
            // Note: The model name is fixed
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            let response;
            // Simple retry logic with exponential backoff
            for (let i = 0; i < 3; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break;

                    // Wait before retrying (1s, 2s, 4s...)
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                } catch (error) {
                    console.warn(`Attempt ${i + 1} failed:`, error);
                    if (i === 2) {
                         loadingDiv.classList.add('hidden');
                         outputContainer.innerHTML = '<p class="text-red-600">Failed to connect to the Gemini API after multiple retries.</p>';
                         return;
                    }
                }
            }

            loadingDiv.classList.add('hidden');
            
            // IMPROVED ERROR HANDLING: Check for non-200 responses outside the loop
            if (!response || !response.ok) {
                let errorText = `API Request failed with status: ${response ? response.status : 'Unknown'}. Please try again later.`;
                
                // Attempt to get specific error message from the response body if it's JSON
                try {
                    const errorJson = await (response ? response.json() : Promise.resolve(null));
                    if (errorJson && errorJson.error && errorJson.error.message) {
                        // This handles the 403 specific message you received
                        errorText += `<br>Detail: ${errorJson.error.message}`; 
                    }
                } catch (e) {
                    // Ignore JSON parsing errors for the error body itself
                }

                outputContainer.innerHTML = `<p class="text-red-600 font-semibold">${errorText}</p>`;
                console.error("Final API response check failed:", response);
                return; // Exit the function if the API call failed
            }


            try {
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    let sources = [];
                    
                    // Extract grounding sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    // Display text
                    outputContainer.innerHTML = `<p class="text-gray-700">${text}</p>`;

                    // Display sources
                    if (sources.length > 0) {
                        let sourceHtml = '<p class="text-xs mt-3 text-gray-500 font-medium">Sources:</p>';
                        sourceHtml += '<ul class="list-disc list-inside text-xs text-gray-500 space-y-0.5">';
                        sources.slice(0, 3).forEach(source => { // Limit to 3 sources for brevity
                            sourceHtml += `<li><a href="${source.uri}" target="_blank" class="hover:underline">${source.title}</a></li>`;
                        });
                        sourceHtml += '</ul>';
                        outputContainer.innerHTML += sourceHtml;
                    }

                } else {
                    // The old error message is preserved for when the response is OK but the structure is bad
                    outputContainer.innerHTML = '<p class="text-red-600">Could not generate scenario. The model returned an empty or unexpected response.</p>';
                }
            } catch (e) {
                loadingDiv.classList.add('hidden');
                outputContainer.innerHTML = '<p class="text-red-600">An error occurred while processing the response body as JSON (e.g., malformed body).</p>';
                console.error("LLM API Processing Error:", e);
            }
        }
    </script>
</body>
</html>
